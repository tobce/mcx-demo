<!DOCTYPE html>
<html lang="nn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>PTX-demo</title>
</head>
<body>
    <h1>PTX-demo</h1>
    <form id="innloggingSkjema">
        <h2>Innlogging</h2>
        <label for="brukarnamn">Brukarnamn:</label>
        <input type="text" id="brukarnamn" required>
        <button type="submit">Logg inn</button>
    </form>

    <div id="pttKontrollar" style="display: none;">
        <h2>Velkomen!</h2>
        <p>Du er no innlogga som <span id="brukarnamnSpan"></span>.</p>

        <h3>Talegruppe</h3>
        <div>
            <label for="gruppe1"><input type="radio" id="gruppe1" name="gruppe" value="0" checked>
            Gruppe 1</label>
            <label for="gruppe2"><input type="radio" id="gruppe2" name="gruppe" value="1">
            Gruppe 2</label>
        </div>
        
        <h3>Melding</h3>
        <div>
            <label for="ja"><input type="radio" id="ja" name="ptt-melding" value="Ja" checked>
            Ja</label>
            <label for="nei"><input type="radio" id="nei" name="ptt-melding" value="Nei">
            Nei</label>
            <label for="kanskje"><input type="radio" id="kanskje" name="ptt-melding" value="Kanskje">
            Kanskje</label>
        </div>

        <h3>PTT</h3>
        <button id="pttKnapp">Trykk for å snakke</button>

        <h3>Status</h3>
        <div id="status">Status: Ledig</div>
        <div id="gruppenamn">Gruppe: Ingen</div>
        <div id="sendarBrukarnamn">Brukarnamn: Ingen</div>
        <div id="pttMelding">Melding: Ingen</div>
    </div>

    <script>
        const skjema = document.getElementById('innloggingSkjema');
        const pttKontrollar = document.getElementById('pttKontrollar');
        const pttKnapp = document.getElementById('pttKnapp');
        const statusDiv = document.getElementById('status');
        const gruppenamnDiv = document.getElementById('gruppenamn');
        const pttMeldingDiv = document.getElementById('pttMelding');
        const sendarBrukarnamnDiv = document.getElementById('sendarBrukarnamn');
        let brukarnamn = '';
        let socket;
        let senderBool = false;

        skjema.addEventListener('submit', (e) => {
            e.preventDefault();
            brukarnamn = document.getElementById('brukarnamn').value;
            
            // Send POST-forespørsel for innlogging
            fetch('/innlogging', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brukarnamn })
            })
            .then(response => {
            if (response.ok) {
                skjema.style.display = 'none';
                pttKontrollar.style.display = 'block';
                document.getElementById('brukarnamnSpan').textContent = brukarnamn;
                opprettWebSocket();
            } else {
                alert('Innlogging feila');
            }
            });
        });

        function opprettWebSocket() {
            const sokkel = new WebSocket('ws://localhost:3000');

            function deaktiverRadioKnappar() {
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(button => button.disabled = true);
        }

        function aktiverRadioKnappar() {
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(button => button.disabled = false);
        }

        function deaktiverPttKnapp() {
            const pttKnapp = document.getElementById('pttKnapp');
            pttKnapp.disabled = true;
        }

        function aktiverPttKnapp() {
            const pttKnapp = document.getElementById('pttKnapp');
            pttKnapp.disabled = false;
        }
        
            // Motta
            sokkel.onmessage = (melding) => {
                const data = JSON.parse(melding.data);
                console.log(data);

                grupper = data.grupper;
                const gruppeId = data.gruppeId;
                const gruppe = grupper.find(gr => gr.id == gruppeId);
                const gruppenamn = gruppe ? gruppe.gruppenamn : 'Ingen';
                
                if (data.type === 'PTT_START' && gruppeId == document.querySelector('input[name="gruppe"]:checked').value) {
                    deaktiverRadioKnappar();
                    if (!senderBool) {
                        deaktiverPttKnapp();
                    }
                    if (senderBool) {
                        statusDiv.textContent = 'Status: Du sender';
                    }
                    else {
                        statusDiv.textContent = 'Status: Opptatt';
                    }
                    
                    pttMeldingDiv.textContent = 'Melding: ' + data.pttMelding;
                    sendarBrukarnamnDiv.textContent = 'Brukarnamn: ' + data.brukarnamn;
                    gruppenamnDiv.textContent = 'Gruppe: ' + gruppenamn;
                } else if (data.type === 'PTT_END') {
                    aktiverRadioKnappar();
                    if (!senderBool) {
                        aktiverPttKnapp();
                    }
                    statusDiv.textContent = 'Status: Ledig';
                    pttMeldingDiv.textContent = 'Melding: Ingen';
                    sendarBrukarnamnDiv.textContent = 'Brukarnamn: Ingen';
                    gruppenamnDiv.textContent = 'Gruppe: Ingen';
                }
            };

            // Sende
            pttKnapp.addEventListener('mousedown', () => {
                senderBool = true;
                deaktiverRadioKnappar();
                const gruppeId = document.querySelector('input[name="gruppe"]:checked').value;
                const pttMelding = document.querySelector('input[name="ptt-melding"]:checked').value;
                sokkel.send(JSON.stringify({ 
                    type: 'PTT_START', 
                    brukarnamn, 
                    gruppeId, 
                    pttMelding 
                }));
            });

            pttKnapp.addEventListener('mouseup', () => {
                senderBool = false;
                aktiverRadioKnappar();
                const gruppeId = document.querySelector('input[name="gruppe"]:checked').value;
                sokkel.send(JSON.stringify({ 
                    type: 'PTT_END', 
                    brukarnamn, 
                    gruppeId
                }));
            });
        }
    </script>
</body>
</html>
