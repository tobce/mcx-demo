<!DOCTYPE html>
<html lang="nn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>PTX-demo</title>
</head>
<body>
    <h1>PTX-demo</h1>
    <form id="innloggingSkjema">
        <h2>Innlogging</h2>
        <label for="fødselsnummer">Fødselsnummer:</label>
        <input type="text" id="fødselsnummer" required>
        <button type="submit">Logg inn</button>
        <p id="feilmeldingP" class="error-message"></p>
    </form>

    <div id="ptxKontrollar" style="display: none;">
        <h2>Velkomen!</h2>
        <p>Du er no innlogga som <span id="namnSpan"></span> (fnr.: <span id="avsSpan"></span>).</p>

        <h3>Talegruppe</h3>
        <div id="talegruppeContainer"></div>
        
        <h3>Melding</h3>
        <div>
            <label for="ja"><input type="radio" id="ja" name="tekstmelding" value="Ja" checked>
            Ja</label>
            <label for="nei"><input type="radio" id="nei" name="tekstmelding" value="Nei">
            Nei</label>
            <label for="kanskje"><input type="radio" id="kanskje" name="tekstmelding" value="Kanskje">
            Kanskje</label>
            <label for="tekstfeltRadio"><input type="radio" id="tekstfeltRadio" name="tekstmelding" value="">
            Eigen tekst:</label>
            <input type="text" id="tekstfelt" name="tekstmelding" oninput="document.getElementById('tekstfeltRadio').value = this.value; document.getElementById('tekstfeltRadio').checked = true;">
        </div>

        <h3>Tekstmelding</h3>
        <button id="tekstmeldingKnapp">Send tekstmelding</button>

        <h3>PTT (lyd)</h3>
        <button id="pttKnapp">PTT</button>

        <h3>Status</h3>
        <div id="status">
            <div id="statusmelding">Status: Ledig</div>
            <div id="talegruppenamn">Talegruppe: Ingen</div>
            <div id="avsendar">Avsendar: Ingen</div>
        </div>
    </div>

    <script>
        const skjema = document.getElementById('innloggingSkjema');
        const ptxKontrollar = document.getElementById('ptxKontrollar');
        const tekstmeldingKnapp = document.getElementById('tekstmeldingKnapp');
        const pttKnapp = document.getElementById('pttKnapp');
        const statusDiv = document.getElementById('statusmelding');
        const talegruppenamnDiv = document.getElementById('talegruppenamn');
        const avsendarDiv = document.getElementById('avsendar');
        const talegruppeContainer = document.getElementById('talegruppeContainer');
        const feilmelding = document.getElementById('feilmeldingP');
        let brukar;
        let fødselsnummer = '';
        let talegrupper = [];
        let socket;
        let senderBool = false;

        skjema.addEventListener('submit', (e) => {
            e.preventDefault();
            fødselsnummer = document.getElementById('fødselsnummer').value;
            feilmelding.textContent = ''; // Clear the error message
            const minForseinking = 500;
            const maxForseinking = 1000;
            const forseinking = Math.floor(Math.random() * (maxForseinking - minForseinking + 1)) + minForseinking;
            
            // Send POST-forespørsel for innlogging
            const startTime = Date.now();

            fetch('/innlogging', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fødselsnummer })
            })
            .then(response => response.json())
            .then(data => {
                const elapsedTime = Date.now() - startTime;
                const delay = Math.max(0, forseinking - elapsedTime);

                return new Promise(resolve => setTimeout(() => resolve(data), delay));
            })
            .then(data => {
                if (data.brukar) {
                    brukar = data.brukar; // Initiate the global variable
                    skjema.style.display = 'none';
                    ptxKontrollar.style.display = 'block';
                    document.getElementById('namnSpan').textContent = brukar.namn;
                    document.getElementById('avsSpan').textContent = brukar.fødselsnummer;
                    fødselsnummer = brukar.fødselsnummer;
                    talegrupper = brukar.talegrupper;
                    opprettWebSocket();
                    genererTalegruppeRadioKnappar(talegrupper);
                } else {
                    feilmelding.textContent = 'Innlogging feila, prøv på nytt';
                }
            });
        });

        function genererTalegruppeRadioKnappar(talegrupper) {
            talegruppeContainer.innerHTML = '';
            talegrupper.forEach((talegruppe, index) => {
                const label = document.createElement('label');
                label.setAttribute('for', talegruppe.id);
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = talegruppe.id;
                input.name = 'talegruppe';
                input.value = talegruppe.id;
                if (index === 0) input.checked = true;
                label.appendChild(input);
                label.appendChild(document.createTextNode(` ${talegruppe.namn}`));
                talegruppeContainer.appendChild(label);
            });
        }

        function deaktiverRadioKnappar() {
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(button => button.disabled = true);
        }

        function aktiverRadioKnappar() {
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(button => button.disabled = false);
        }

        function deaktiverPttKnapp() {
            pttKnapp.disabled = true;
        }

        function aktiverTekstmeldingKnapp() {
            tekstmeldingKnapp.disabled = false;
        }

        function opprettWebSocket() {
            const sokkel = new WebSocket('ws://localhost:3000');
        
            // Motta
            sokkel.onmessage = (melding) => {
                const data = JSON.parse(melding.data);
                const avsendarTalegruppe = data.avsendarTalegruppe;
                const avsendarBrukar = data.avsendarBrukar;
                
                switch (data.type) {
                    case 'PTT_START':
                        if (avsendarTalegruppe.id == document.querySelector('input[name="talegruppe"]:checked').value) {
                            deaktiverRadioKnappar();
                            if (!senderBool) {
                                deaktiverPttKnapp();
                            }
                            statusDiv.textContent = senderBool 
                            ? 'Status: Du sender' 
                            : 'Status: Opptatt';
                            avsendarDiv.textContent = 'Avsendar: ' +  avsendarBrukar.fødselsnummer;
                            talegruppenamnDiv.textContent = 'Talegruppe: ' + avsendarTalegruppe.namn;
                        }
                        break;

                    case 'PTT_END':
                        aktiverRadioKnappar();
                        if (!senderBool) {
                            aktiverTekstmeldingKnapp();
                        }
                        statusDiv.textContent = 'Status: Ledig';
                        avsendarDiv.textContent = 'Avsendar: Ingen';
                        talegruppenamnDiv.textContent = 'Talegruppe: Ingen';
                        break;

                    case 'TEKSTMELDING_TIL_TALEGRUPPE':
                        if (data.avsendarTalegruppe.id == document.querySelector('input[name="talegruppe"]:checked').value) {
                            console.log(brukar)
                            console.log(data.avsendarBrukar)
                            const melding = brukar == data.avsendarBrukar 
                                ? `Du sende følgjande tekstmelding i talegruppe ${avsendarTalegruppe.namn}:\n${data.tekstmelding}`
                                : `Ny melding mottatt frå ${data.avsendarBrukar.namn} i talegruppe ${data.avsendarTalegruppe.namn}:\n${data.tekstmelding}`;
                            alert(melding);
                        }
                        break;

                    default:
                        console.log('Ukjent meldingstype mottatt:', data.type);
                        break;
                }
            }

            // Sende tekstmelding
            tekstmeldingKnapp.addEventListener('click', () => {
                const talegruppeId = document.querySelector('input[name="talegruppe"]:checked').value;
                const talegruppe = talegrupper.find(gr => gr.id == talegruppeId);
                const tekstmelding = document.querySelector('input[name="tekstmelding"]:checked').value;
                sokkel.send(JSON.stringify({ 
                    type: 'TEKSTMELDING_TIL_TALEGRUPPE', 
                    avsendarBrukar : brukar, 
                    avsendarTalegruppe : talegruppe, 
                    tekstmelding 
                }));
            });

            // funksjon, starte PTT
            function startPTT() {
                senderBool = true;
                deaktiverRadioKnappar();
                const talegruppeId = document.querySelector('input[name="talegruppe"]:checked').value;
                const talegruppe = talegrupper.find(gr => gr.id == talegruppeId);
                sokkel.send(JSON.stringify({ 
                    type: 'PTT_START', 
                    avsendarBrukar : brukar, 
                    avsendarTalegruppe : talegruppe
                }));
            }

            // funksjon, stoppe PTT
            function stopPTT() {
                senderBool = false;
                aktiverRadioKnappar();
                const talegruppeId = document.querySelector('input[name="talegruppe"]:checked').value;
                const talegruppe = talegrupper.find(gr => gr.id == talegruppeId);
                sokkel.send(JSON.stringify({ 
                    type: 'PTT_END', 
                    avsendarBrukar : brukar, 
                    avsendarTalegruppe : talegruppe
                }));
            }

            // Start PTT on mouse down or touch start
            pttKnapp.addEventListener('mousedown', startPTT);
            pttKnapp.addEventListener('touchstart', startPTT);

            // Stop PTT on mouse up or touch end
            pttKnapp.addEventListener('mouseup', stopPTT);
            pttKnapp.addEventListener('touchend', stopPTT);
        }

        function startLydKommunikasjon() {
            console.log('Start lydkommunikasjon');
            // Implement WebRTC logic here
        }
    </script>
</body>
</html>
