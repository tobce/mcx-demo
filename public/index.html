<!DOCTYPE html>
<html lang="nn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>PTX-demo</title>
</head>
<body>
    <h1>PTX-demo</h1>
    <form id="innloggingSkjema">
        <h2>Innlogging</h2>
        <label for="fødselsnummer">Fødselsnummer:</label>
        <input type="text" id="fødselsnummer" required>
        <button type="submit">Logg inn</button>
        <p id="feilmeldingP" class="feilmelding"></p>
    </form>

    <div id="ptxKontrollar" style="display: none;">
        <h2>Velkomen!</h2>
        <p>Du er no innlogga som <span id="namnSpan"></span> (fnr.: <span id="fnrSpan"></span>).</p>

        <h3>Talegruppe</h3>
        <div id="talegruppeContainer"></div>
        
        <h3>Melding</h3>
        <div>
            <label for="ja"><input type="radio" id="ja" name="tekstmelding" value="Ja" checked>
            Ja</label>
            <label for="nei"><input type="radio" id="nei" name="tekstmelding" value="Nei">
            Nei</label>
            <label for="kanskje"><input type="radio" id="kanskje" name="tekstmelding" value="Kanskje">
            Kanskje</label>
            <label for="tekstfeltRadio"><input type="radio" id="tekstfeltRadio" name="tekstmelding" value="">
            Eigen tekst:</label>
            <input type="text" id="tekstfelt" name="tekstmelding" oninput="document.getElementById('tekstfeltRadio').value = this.value; document.getElementById('tekstfeltRadio').checked = true;">
        </div>

        <h3>Tekstmelding</h3>
        <button id="tekstmeldingKnapp">Send tekstmelding</button>

        <h3>PTT (lyd)</h3>
        <button id="pttKnapp">PTT</button>

        <h3>Status</h3>
        <div id="status">
            <div id="statusmelding">Status: Ledig</div>
            <div id="talegruppenamn">Talegruppe: Ingen</div>
            <div id="avsendar">Avsendar: Ingen</div>
        </div>
    </div>

    <script>

        const skjema = document.getElementById('innloggingSkjema');
        const ptxKontrollar = document.getElementById('ptxKontrollar');
        const tekstmeldingKnapp = document.getElementById('tekstmeldingKnapp');
        const pttKnapp = document.getElementById('pttKnapp');
        const statusDiv = document.getElementById('statusmelding');
        const talegruppenamnDiv = document.getElementById('talegruppenamn');
        const avsendarDiv = document.getElementById('avsendar');
        const talegruppeContainer = document.getElementById('talegruppeContainer');
        const feilmelding = document.getElementById('feilmeldingP');
        let brukar;
        let fødselsnummer = '';
        let talegrupper = [];
        let socket;
        let senderBool = false;

        skjema.addEventListener('submit', (e) => {
            document.querySelector('button[type="submit"]').disabled = true;
            e.preventDefault();
            fødselsnummer = document.getElementById('fødselsnummer').value;
            feilmelding.textContent = ''; // Fjern feilmelding
            const minForseinking = 500;
            const maxForseinking = 1000;
            const forseinking = Math.floor(Math.random() * (maxForseinking - minForseinking + 1)) + minForseinking;
            
            // Send POST-forespørsel for innlogging
            const startTime = Date.now();

            fetch('/innlogging', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fødselsnummer })
            })
            .then(response => response.json())
            .then(data => {
                return new Promise(resolve => setTimeout(() => resolve(data), forseinking));
            })
            .then(data => {
                if (data.brukar) {
                    brukar = data.brukar;
                    talegrupper = brukar.talegrupper;
                    skjema.style.display = 'none';
                    ptxKontrollar.style.display = 'block';
                    document.getElementById('namnSpan').textContent = brukar.namn;
                    document.getElementById('fnrSpan').textContent = brukar.fødselsnummer;
                    ptxKontrollar.style.display = 'block';
                    opprettWebSocket();
                    genererTalegruppeRadioKnappar(talegrupper);
                } else {
                    feilmelding.textContent = data.melding;
                    document.querySelector('button[type="submit"]').disabled = false;
                }
            });
        });

        function genererTalegruppeRadioKnappar(talegrupper) {
            talegruppeContainer.innerHTML = '';
            talegrupper.forEach((talegruppe, index) => {
                const label = document.createElement('label');
                label.setAttribute('for', talegruppe.id);
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = talegruppe.id;
                input.name = 'talegruppe';
                input.value = talegruppe.id;
                if (index === 0) input.checked = true;
                label.appendChild(input);
                label.appendChild(document.createTextNode(` ${talegruppe.namn}`));
                talegruppeContainer.appendChild(label);
            });
        }

        
        let peerConnection;
        let iceCandidateQueue = [];
        let isPeerConnectionReady = false;

        function opprettWebSocket() {
            const socketUrl = `wss://${window.location.host.replace(/^https?:\/\//, '')}`;
            socket = new WebSocket(socketUrl);

            socket.onmessage = async (event) => {
                const data = JSON.parse(event.data);

                switch (data.type) {
                    /*case 'answer':
                        try {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                            isPeerConnectionReady = true;
                            processIceCandidateQueue();
                        } catch (error) {
                            console.error('Klarte ikkje å setje fjernbeskriving:', error);
                        }
                        break;

                    case 'candidate':
                        if (isPeerConnectionReady && peerConnection) {
                            try {
                                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                            } catch (error) {
                                console.error('Klarte ikkje å leggje til ICE-kandidat:', error);
                            }
                        } else {
                            iceCandidateQueue.push(data.candidate);
                        }
                        break;
                    
                    case 'offer':
                        await handleOffer(data);
                        break;
                    */

                    case 'PTT_START':
                        handterPTTStart(data);
                        break;

                    case 'PTT_END':
                        handterPTTSlutt(data);
                        break;

                    case 'TEKSTMELDING_TIL_TALEGRUPPE':
                        handterTekstmelding(data);
                        break;

                    default:
                        console.log('Ukjent meldingstype:', data.type);
                        break;
                }
            };
        }

        /*
        async function handleOffer(data) {
            if (!peerConnection) {
                peerConnection = new RTCPeerConnection();
                peerConnection.onicecandidate = ({ candidate }) => {
                    if (candidate) {
                        socket.send(JSON.stringify({ type: 'candidate', candidate }));
                    }
                };
            }
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.send(JSON.stringify({ type: 'answer', answer }));
                isPeerConnectionReady = true;
                processIceCandidateQueue();
            } catch (error) {
                console.error('Klarte ikkje å handtere tilbod:', error);
            }
        }

        function processIceCandidateQueue() {
            while (iceCandidateQueue.length > 0) {
                const candidate = iceCandidateQueue.shift();
                if (peerConnection) {
                    try {
                        if (peerConnection.signalingState !== 'closed') {
                            peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                        } else {
                            console.warn('RTCPeerConnection er stengd. Hopp over ICE-kandidat.');
                        }
                    } catch (error) {
                        console.error('Klarte ikkje å leggje til ICE-kandidat:', error);
                    }
                }
            }
        }
        */

        function deaktiverRadioKnappar() {
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(button => button.disabled = true);
        }

        function aktiverRadioKnappar() {
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(button => button.disabled = false);
        }

        //let localStream;

        async function sendTekstmelding() {
            const talegruppeId = document.querySelector('input[name="talegruppe"]:checked').value;
            const talegruppe = talegrupper.find(gr => gr.id == talegruppeId);
            const tekstmelding = document.querySelector('input[name="tekstmelding"]:checked').value;
            socket.send(JSON.stringify({
                type: 'TEKSTMELDING_TIL_TALEGRUPPE',
                avsendarBrukar: brukar,
                avsendarTalegruppe: talegruppe,
                tekstmelding
            }));
        }

        async function startPTT() {
            senderBool = true;
            deaktiverRadioKnappar();
            const talegruppeId = document.querySelector('input[name="talegruppe"]:checked').value;
            const talegruppe = talegrupper.find(gr => gr.id == talegruppeId);

            socket.send(JSON.stringify({
                type: 'PTT_START',
                avsendarBrukar: brukar,
                avsendarTalegruppe: talegruppe,
            }));

            /*try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                peerConnection = new RTCPeerConnection();
                peerConnection.onicecandidate = ({ candidate }) => {
                    if (candidate) {
                        socket.send(JSON.stringify({ type: 'candidate', candidate }));
                    }
                };

                const audioTrack = localStream.getAudioTracks()[0];
                const sender = peerConnection.addTrack(audioTrack, localStream);

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                socket.send(JSON.stringify({ type: 'offer', offer }));
                isPeerConnectionReady = true;
            } catch (error) {
                console.error('Klarte ikkje å starte PTT:', error);
            }*/
        }

        async function stoppPTT() {
            senderBool = false;
            aktiverRadioKnappar();
            const talegruppeId = document.querySelector('input[name="talegruppe"]:checked').value;
            const talegruppe = talegrupper.find(gr => gr.id == talegruppeId);

            socket.send(JSON.stringify({
                type: 'PTT_END',
                avsendarBrukar: brukar,
                avsendarTalegruppe: talegruppe
            }));

            /*if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
                isPeerConnectionReady = false;
            }*/
        }

        function handterPTTStart(data) {
            const avsendarTalegruppe = data.avsendarTalegruppe;
            const avsendarBrukar = data.avsendarBrukar;

            if (avsendarTalegruppe.id == document.querySelector('input[name="talegruppe"]:checked').value) {
                deaktiverRadioKnappar();
                if (!senderBool) {
                    pttKnapp.disabled = true;
                }
                statusDiv.textContent = senderBool 
                    ? 'Status: Du sender' 
                    : 'Status: Opptatt';
                avsendarDiv.textContent = 'Avsendar: ' +  avsendarBrukar.fødselsnummer;
                talegruppenamnDiv.textContent = 'Talegruppe: ' + avsendarTalegruppe.namn;
            }
        }

        function handterPTTSlutt(data) {
            aktiverRadioKnappar();
            if (!senderBool) {
                pttKnapp.disabled = false;
            }
            statusDiv.textContent = 'Status: Ledig';
            avsendarDiv.textContent = 'Avsendar: Ingen';
            talegruppenamnDiv.textContent = 'Talegruppe: Ingen';
        }

        function handterTekstmelding(data) {
            if (data.avsendarTalegruppe.id == document.querySelector('input[name="talegruppe"]:checked').value) {
                const melding = brukar.fødselsnummer == data.avsendarBrukar.fødselsnummer 
                    ? `Du sende følgjande tekstmelding i talegruppe ${data.avsendarTalegruppe.namn}:\n${data.tekstmelding}`
                    : `Ny melding mottatt frå ${data.avsendarBrukar.namn} i talegruppe ${data.avsendarTalegruppe.namn}:\n${data.tekstmelding}`;
                alert(melding);
            }
        }

        tekstmeldingKnapp.addEventListener('click', sendTekstmelding);

        pttKnapp.addEventListener('mousedown', startPTT);
        pttKnapp.addEventListener('touchstart', startPTT);

        pttKnapp.addEventListener('mouseup', stoppPTT);
        pttKnapp.addEventListener('touchend', stoppPTT);

    </script>
</body>
</html>
