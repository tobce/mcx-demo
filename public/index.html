<!DOCTYPE html>
<html lang="nn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>PTX-demo</title>
</head>
<body>
    <h1>PTX-demo</h1>
    <form id="innloggingSkjema">
        <h2>Innlogging</h2>
        <label for="brukarnamn">Brukarnamn:</label>
        <input type="text" id="brukarnamn" required>
        <button type="submit">Logg inn</button>
        <p id="feilmeldingP" class="error-message"></p>
    </form>

    <div id="tekstmeldingKontrollar" style="display: none;">
        <h2>Velkomen!</h2>
        <p>Du er no innlogga som <span id="brukarnamnSpan"></span> (ID: <span id="brukarIdSpan"></span>).</p>

        <h3>Talegruppe</h3>
        <div id="gruppeContainer"></div>
        
        <h3>Melding</h3>
        <div>
            <label for="ja"><input type="radio" id="ja" name="tekstmelding" value="Ja" checked>
            Ja</label>
            <label for="nei"><input type="radio" id="nei" name="tekstmelding" value="Nei">
            Nei</label>
            <label for="kanskje"><input type="radio" id="kanskje" name="tekstmelding" value="Kanskje">
            Kanskje</label>
            <label for="tekstfeltRadio"><input type="radio" id="tekstfeltRadio" name="tekstmelding" value="">
            Eigen tekst:</label>
            <input type="text" id="tekstfelt" name="tekstmelding" oninput="document.getElementById('tekstfeltRadio').value = this.value; document.getElementById('tekstfeltRadio').checked = true;">
        </div>

        <h3>Tekstmelding</h3>
        <button id="tekstmeldingKnapp">Send tekstmelding</button>

        <h3>PTT (lyd)</h3>
        <button id="pttKnapp">PTT</button>

        <h3>Status</h3>
        <div id="status">
            <div id="statusmelding">Status: Ledig</div>
            <div id="gruppenamn">Gruppe: Ingen</div>
            <div id="sendarBrukarnamn">Brukarnamn: Ingen</div>
            <div id="id">ID: Ingen</div>
        </div>
    </div>

    <script>
        const skjema = document.getElementById('innloggingSkjema');
        const tekstmeldingKontrollar = document.getElementById('tekstmeldingKontrollar');
        const tekstmeldingKnapp = document.getElementById('tekstmeldingKnapp');
        const pttKnapp = document.getElementById('pttKnapp');
        const statusDiv = document.getElementById('statusmelding');
        const gruppenamnDiv = document.getElementById('gruppenamn');
        const idDiv = document.getElementById('id');
        const sendarBrukarnamnDiv = document.getElementById('sendarBrukarnamn');
        const gruppeContainer = document.getElementById('gruppeContainer');
        const feilmelding = document.getElementById('feilmeldingP');
        let brukarnamn = '';
        let brukarId = '';
        let socket;
        let senderBool = false;

        skjema.addEventListener('submit', (e) => {
            e.preventDefault();
            brukarnamn = document.getElementById('brukarnamn').value;
            feilmelding.textContent = ''; // Clear the error message
            const minForseinking = 500;
            const maxForseinking = 1000;
            const forseinking = Math.floor(Math.random() * (maxForseinking - minForseinking + 1)) + minForseinking;
            
            // Send POST-forespørsel for innlogging
            const startTime = Date.now();

            fetch('/innlogging', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brukarnamn })
            })
            .then(response => response.json())
            .then(data => {
                const elapsedTime = Date.now() - startTime;
                const delay = Math.max(0, forseinking - elapsedTime);

                return new Promise(resolve => setTimeout(() => resolve(data), delay));
            })
            .then(data => {
                if (data.brukarnamn) {
                    skjema.style.display = 'none';
                    tekstmeldingKontrollar.style.display = 'block';
                    document.getElementById('brukarnamnSpan').textContent = brukarnamn;
                    document.getElementById('brukarIdSpan').textContent = data.id;
                    opprettWebSocket();
                    genererGruppeRadioKnappar(data.grupper);
                } else {
                    feilmelding.textContent = 'Innlogging feila, prøv på nytt';
                }
            });
        });

        function genererGruppeRadioKnappar(grupper) {
            gruppeContainer.innerHTML = '';
            grupper.forEach((gruppe, index) => {
                const label = document.createElement('label');
                label.setAttribute('for', `gruppe${gruppe.id}`);
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = `gruppe${gruppe.id}`;
                input.name = 'gruppe';
                input.value = gruppe.id;
                if (index === 0) input.checked = true;
                label.appendChild(input);
                label.appendChild(document.createTextNode(` ${gruppe.gruppenamn}`));
                gruppeContainer.appendChild(label);
            });
        }

        function deaktiverRadioKnappar() {
                const radioButtons = document.querySelectorAll('input[type="radio"]');
                radioButtons.forEach(button => button.disabled = true);
            }

            function aktiverRadioKnappar() {
                const radioButtons = document.querySelectorAll('input[type="radio"]');
                radioButtons.forEach(button => button.disabled = false);
            }

            function deaktiverPttKnapp() {
                const pttKnapp = document.getElementById('pttKnapp');
                pttKnapp.disabled = true;
            }

            function aktiverTekstmeldingKnapp() {
                const tekstmeldingKnapp = document.getElementById('tekstmeldingKnapp');
                pttKnapp.disabled = false;
            }

        function opprettWebSocket() {
            const sokkel = new WebSocket('ws://localhost:3000');
        
            // Motta
            sokkel.onmessage = (melding) => {
                const data = JSON.parse(melding.data);
                console.log(data);

                grupper = data.grupper;
                const gruppeId = data.gruppeId;
                const gruppe = grupper.find(gr => gr.id == gruppeId);
                const gruppenamn = gruppe ? gruppe.gruppenamn : 'Ingen';
                
                if (data.type === 'PTT_START' && gruppeId == document.querySelector('input[name="gruppe"]:checked').value) {
                    deaktiverRadioKnappar();
                    if (!senderBool) {
                        deaktiverPttKnapp();
                    }
                    if (senderBool) {statusDiv.textContent = 'Status: Du sender';}
                    else {statusDiv.textContent = 'Status: Opptatt';}
                    
                    idDiv.textContent = 'ID: ' + data.id;
                    sendarBrukarnamnDiv.textContent = 'Brukarnamn: ' + data.brukarnamn;
                    gruppenamnDiv.textContent = 'Gruppe: ' + gruppenamn;
                } else if (data.type === 'PTT_END') {
                    aktiverRadioKnappar();
                    if (!senderBool) {
                        aktiverTekstmeldingKnapp();
                    }
                    statusDiv.textContent = 'Status: Ledig';
                    sendarBrukarnamnDiv.textContent = 'Brukarnamn: Ingen';
                    gruppenamnDiv.textContent = 'Gruppe: Ingen';
                } else if (data.type === 'TEKSTMELDING_TIL_GRUPPE' && gruppeId == document.querySelector('input[name="gruppe"]:checked').value) {
                    idDiv.textContent = 'ID: ' + data.id;
                    sendarBrukarnamnDiv.textContent = 'Brukarnamn: ' + data.brukarnamn;
                    if (brukarnamn == data.brukarnamn) {
                        alert('Du sende følgjande tekstmelding i gruppe ' + gruppenamn +":\n" + data.tekstmelding);
                    }
                    else {
                        alert('Ny melding mottatt frå ' + data.brukarnamn + ' i gruppe ' + gruppenamn +":\n" + data.tekstmelding);

                    }
                }
            };

            // Sende tekstmelding
            tekstmeldingKnapp.addEventListener('click', () => {
                const gruppeId = document.querySelector('input[name="gruppe"]:checked').value;
                const tekstmelding = document.querySelector('input[name="tekstmelding"]:checked').value;
                sokkel.send(JSON.stringify({ 
                    type: 'TEKSTMELDING_TIL_GRUPPE', 
                    brukarnamn, 
                    gruppeId, 
                    tekstmelding 
                }));
            });

            // Start ptt
            pttKnapp.addEventListener('mousedown', () => {
                senderBool = true;
                deaktiverRadioKnappar();
                const gruppeId = document.querySelector('input[name="gruppe"]:checked').value;
                const tekstmelding = document.querySelector('input[name="tekstmelding"]:checked').value;
                sokkel.send(JSON.stringify({ 
                    type: 'PTT_START', 
                    brukarnamn, 
                    gruppeId, 
                    tekstmelding 
                }));
            });

            // Stopp ptt
            pttKnapp.addEventListener('mouseup', () => {
                senderBool = false;
                aktiverRadioKnappar();
                const gruppeId = document.querySelector('input[name="gruppe"]:checked').value;
                sokkel.send(JSON.stringify({ 
                    type: 'PTT_END', 
                    brukarnamn, 
                    gruppeId
                }));
            });

        }

        function startLydKommunikasjon() {
            console.log('Start lydkommunikasjon');
            // Implement WebRTC logic here
        }
    </script>
</body>
</html>
